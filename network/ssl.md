### tls

##### 对称加密

对称加密是指加密和解密都使用的是相同的密钥。

HTTPS 首先协商加解密方式，这个过程就是 HTTPS 建立安全连接的过程。为了让加密的密钥更加难以破解，让服务器和客户端同时决定密钥，具体过程如下：

- 浏览器发送它所支持的加密的方法列表和一个随机数 client-random，加密方法列表就是指浏览器能支持多少种加密方法。

- 服务器会从加密方法列表中选取一个加密方法，然后还会生成一个随机数 service-random，并将 service-random 和加密方法列表返回给浏览器。

- 最后浏览器和服务器分别返回确认消息。

这样浏览器端和服务器端都有相同的 client-random 和 service-random 了，然后它们再使用相同的方法将 client-random 和 service-random 混合起来生成一个密钥 master secret，有了密钥 master secret 和加密套件之后，双方就可以进行数据的加密传输了。



##### 非对称加密

非对称加密算法有两公钥和私钥，公钥加密，私钥来解密；反过来，似钥来加密，公钥来解密。

在 HTTPS 中，服务器会将公钥通过明文的形式发送给浏览器，服务器自己留下私钥。公钥是每个人都能获取到的，而私钥只有服务器才能知道，不对任何人公开。

- 首先浏览器还是发送加密方法列表给服务器。

- 然后服务器会选择一个方法，和对称加密不同的是，使用非对称加密时，服务器上需要有用于浏览器加密的公钥和服务器解密 HTTP 数据的私钥，由于公钥是给浏览器加密使用的，因此服务器会将加密方法和公钥一道发送给浏览器。

- 最后浏览器和服务器返回确认消息。

这样浏览器端就有了服务器的公钥，在浏览器端向服务器端发送数据时，就可以使用该公钥来加密数据。由于公钥加密的数据只有私钥才能解密，所以即便黑客截获了数据和公钥也无法解密数据。

##### 问题

非对称加密的效率太低。这会严重影响到加解密数据的速度。

无法保证服务器发送给浏览器的数据安全。虽然浏览器端可以使用公钥来加密，但是服务器端只能采用私钥来加密，私钥加密只有公钥能解密，但黑客也是可以获取得到公钥的，这样就不能保证服务器端数据的安全了。

### 对称加密和非对称加密搭配使用

在传输数据阶段依然使用对称加密，但是对称加密的密钥我们采用非对称加密来传输。

- 首先浏览器向服务器发送对称加密方法列表、非对称加密方法列表和随机数 client-random；

- 服务器保存随机数 client-random，选择对称加密和非对称加密的方法，然后生成随机数 service-random，向浏览器发送选择的加密方法、service-random 和公钥；

- 浏览器保存公钥，并生成随机数 pre-master，然后利用公钥对 pre-master 加密，并向服务器发送加密后的数据；

- 最后服务器拿出自己的私钥，解密出 pre-master 数据，并返回确认消息。

### 数字证书

通过对称和非对称混合方式，我们完美地实现了数据的加密传输。

不过这种方式依然存在着问题，黑客可以通过 DNS 劫持将 IP 地址替换成了黑客的 IP 地址，这样访问的其实是黑客的服务器了，黑客就可以在自己的服务器上实现公钥和私钥，而对浏览器来说，它完全不知道现在访问的是个黑客的站点。所以我们还需要服务器向浏览器提供证明“我就是我”。



要证明这个服务器就是自己，需要使用权威机构颁发的证书，这个权威机构称为 CA（Certificate Authority），颁发的证书就称为数字证书（Digital Certificate)。



对于浏览器来说，数字证书有两个作用：

- 一个是通过数字证书向浏览器证明服务器的身份。

- 另一个是数字证书里面包含了服务器公钥。

- 

服务器没有直接返回公钥给浏览器，而是返回了数字证书，而公钥正是包含在数字证书中的。

在浏览器端多了一个证书验证的操作，验证了证书之后，才继续后续流程。

通过引入数字证书，我们就实现了服务器的身份认证功能，这样即便黑客伪造了服务器，但是由于证书是没有办法伪造的，所以无法欺骗用户。



向某个 CA 去申请数字证书，通常的申请流程分以下几步：

- 首先需要准备一套私钥和公钥，私钥留着自己使用；然后向 CA 机构提交公钥、公司、站点等信息并等待认证，这个认证过程可能是收费的；

- CA 通过线上、线下等多种渠道来验证所提供信息的真实性，如公司是否存在、企业是否合法、域名是否归属该企业等；

- 如信息审核通过，CA 会签发认证的数字证书，数字证书包含了公钥、组织信息、CA 的信息、有效时间、证书序列号等，这些信息都是明文的，同时包含一个 CA 生成的签名。

数字签名的过程：

- 首先 CA 使用 Hash 函数来计算提交的明文信息，并得出信息摘要；

- 然后 CA 再使用它的私钥对信息摘要进行加密，加密后的密文就是 CA 颁发的数字签名。这就相当于房管局在房产证上盖的章，这个章是可以去验证的，同样我们也可以通过数字签名来验证是否是该 CA 颁发的。



#### 浏览器验证数字证书

在浏览器和服务器建立 HTTPS 链接的过程中，浏览器首先会向服务器请求数字证书，服务器会返回数字证书给浏览器，之后浏览器要做的第一件事就是验证数字证书。

浏览器需要验证证书的有效期、证书是否被 CA 吊销、证书是否是合法的 CA 机构颁发的。

- 首先浏览器读取证书中相关的明文信息，采用 CA 签名时相同的 Hash 函数来计算并得到信息摘要 A；然后再利用对应 CA 的公钥解密签名数据，得到信息摘要 B；对比信息摘要 A 和信息摘要 B，如果一致，则可以确认证书是合法的，即证明了这个服务器是有效的。

- 验证证书的有效期，数字证书和身份证一样也是有时间期限的，证书里面就含有证书的有效期，浏览器只需要判断当前时间是否在证书的有效期范围内即可。

- 是验证数字证书是否被吊销了。有时候有些数字证书被 CA 吊销了，吊销之后的证书是无法使用的。通常有两种验证方式，一种是下载吊销证书列表 -CRL (Certificate Revocation Lists)，第二种是在线验证方式 -OCSP (Online Certificate Status Protocol)

#### other

申请数字证书是不需要提供私钥的，要确保私钥永远只能由服务器掌握；

数字证书最核心的是 CA 使用它的私钥生成的数字签名；

内置 CA 对应的证书称为根证书，根证书是最权威的机构，它们自己为自己签名，我们把这称为自签名证书。

部署 HTTP 服务器的时候，除了部署当前的数字证书之外，还需要部署 CA 机构的数字证书，CA 机构的数字证书包括了 CA 的公钥，以及 CA 机构的一些基础信息。

因此，服务器就有了两个数字证书:给服务器域名的数字证书；给服务器签名的 CA 机构的数字证书。然后在建立 HTTPS 链接时，服务器会将这两个证书一同发送给浏览器，于是浏览器就可以获取到 CA 的公钥了

如果有些服务器没有部署 CA 的数字证书，那么浏览器还可以通过网络去下载 CA 证书，不过这种方式多了一次证书下载操作，会拖慢首次打开页面的请求速度，一般不推荐使用。



### 证书申请

申请者首先填写了一张含有自己身份信息的表单，身份信息包括了自己公钥、站点资料、公司资料等信息，然后将其提交给了 CA 机构；CA 机构会审核表单中内容的真实性；审核通过后，CA 机构会拿出自己的私钥，对表单的内容进行一连串操作，包括了对明文资料进行 Hash 计算得出信息摘要， 利用 CA 的私钥加密信息摘要得出数字签名，最后将数字签名也写在表单上，并将其返还申请者，这样就完成了一次数字证书的申请操作。



#### 数字证书链

颁发证书的机构划分为两种类型，根 CA(Root CAs)和中间 CA(Intermediates CAs)，通常申请者都是向中间 CA 去申请证书的，而根 CA 作用就是给中间 CA 做认证，一个根 CA 会认证很多中间的 CA，而这些中间 CA 又可以去认证其他的中间 CA



每个根 CA 机构都维护了一个树状结构，一个根 CA 下面包含多个中间 CA，而中间 CA 又可以包含多个中间 CA。这样就形成了一个证书链，你可以沿着证书链从用户证书追溯到根证书



浏览器验证证书时，会先验证当前的证书，如果合法，再验证中间 CA 的证书，如果中间 CA 也是合法的，那么浏览器会继续验证这个中间 CA 的根证书。



如果某个机构想要成为根 CA，并让它的根证书内置到操作系统中，那么这个机构首先要通过 WebTrust 国际安全审计认证。



WebTrust 是由两大著名注册会计师协会 AICPA（美国注册会计师协会）和 CICA（加拿大注册会计师协会）共同制定的安全审计标准，主要对互联网服务商的系统及业务运作逻辑安全性、保密性等共计七项内容进行近乎严苛的审查和鉴证。 

只有通过 WebTrust 国际安全审计认证，根证书才能预装到主流的操作系统，并成为一个可信的认证机构。



### 总结

对称加密实现了安全层，但是由于对称加密的密钥需要明文传输，所以又将对称加密改造成了非对称加密。但是非对称加密效率低且不能加密服务器到浏览器端的数据，于是我们又继续改在安全层，采用对称加密的方式加密传输数据和非对称加密的方式来传输密钥，这样我们就解决传输效率和两端数据安全传输的问题。采用这种方式虽然能保证数据的安全传输，但是依然没办法证明服务器是可靠的，于是又引入了数字证书，数字证书是由 CA 签名过的，所以浏览器能够验证该证书的可靠性。




